---
layout: post
tags: [DB,MariaDB,C,TODO]
categories: blog
---


<!-- vim-markdown-toc GFM -->

* [1 数据库设计的一般步骤](#1-数据库设计的一般步骤)
* [2 需求分析](#2-需求分析)
  * [2.1 分析内容](#21-分析内容)
  * [2.2 数据字典](#22-数据字典)
* [3 概念结构设计](#3-概念结构设计)
  * [3.1 E-R模型](#31-e-r模型)
    * [3.1.1 基本概念](#311-基本概念)
    * [3.1.2 E-R图](#312-e-r图)
    * [3.1.3 完整示例](#313-完整示例)
  * [3.2 设计技巧](#32-设计技巧)
    * [3.2.1 实体与属性的划分原则](#321-实体与属性的划分原则)
* [4 逻辑结构设计](#4-逻辑结构设计)
  * [4.1 E-R图向关系模型的转换](#41-e-r图向关系模型的转换)
* [5 物理结构设计](#5-物理结构设计)
* [6 数据库实施](#6-数据库实施)
* [7 数据库运行与维护](#7-数据库运行与维护)
* [8 简单实例-公交安全管理系统](#8-简单实例-公交安全管理系统)
  * [8.1 题目要求](#81-题目要求)
  * [8.2 概念模型设计](#82-概念模型设计)
  * [8.3 逻辑结构设计](#83-逻辑结构设计)
  * [8.4 物理结构设计](#84-物理结构设计)
  * [8.5 前台程序设计](#85-前台程序设计)
    * [8.5.1 C 语言](#851-c-语言)
    * [8.5.2 Web 网页设计](#852-web-网页设计)
  * [8.6 遇到的问题](#86-遇到的问题)
* [参考资料](#参考资料)

<!-- vim-markdown-toc -->

## 1 数据库设计的一般步骤
1. 需求收集与分析
2. 设计概念结构
3. 设计逻辑结构
4. 设计物理结构
5. 数据库实施
6. 数据库运行与维护

## 2 需求分析
需求分析就是分析用户的要求。

### 2.1 分析内容
* 信息要求
* 处理要求
* 安全性与完整性要求

### 2.2 数据字典
> 数据字典是进行详细的数据收集和数据分析所获得的**主要成果**。它是关于数据库中数据的描述，即**元数据**，而不是数据本身。数据字典是在需求分析阶段建立，在数据库设计过程中不断修改、充实、完善的。它在数据库系统设计中占有很重要的地位

数据字典通常包括**数据项**、**数据结构**、**数据流**、**数据存储**和**处理过程**五个部分。
1. **数据项**: `数据项描述 = {'数据项名', '数据项含义说明', '别名', '数据类型', '长度', '取值范围', '取值含义', '与其它数据项的逻辑关系', '数据项之间的关系'}`
2. **数据结构**: `数据结构描述 = {'数据结构名', '含义说明', '组成: {数据项或数据结构}'}`
3. **数据流**: `数据流描述 = {'数据流名', '说明', '数据流来源', '数据流动向', '组成: {数据结构}', '平均流量', '高峰期流量'}`
4. **数据存储**: `数据存储描述 = {'数据存储名', '说明', '编号输入的数据流', '输出的数据流', '组成：{数据结构}', '数据量', '存取频度', '存取方式'}`
5. **处理过程**: `处理过程描述 = {'处理过程名', '说明', '输入: {数据流}', '输出: {数据流}', '处理: {简要说明}',}`

[E-R]: Entity-Relationship
## 3 概念结构设计
将需求分析得到的用户需求抽象为信息结构（即概念模型）的过程就是概念结构设计。其中概念模型是对信息世界建模，而概念模型的表示方法有很多，但最为常用的是E-R方法（Entity-Relationship approach）。该方法用E-R图（E-R diagram）来描述概念模型，也被称为E-R模型。

### 3.1 E-R模型
#### 3.1.1 基本概念
1. 实体（entity）：客观存在并可相互区别的事物。
2. 属性（attribute）：实体所具有的某一特性。
3. 码（key）：唯一标识实体的属性集（即可以是多个属性）。
4. 实体型（entity type）：用实体名及其属性名集合来抽象和刻画的同类实体。
5. 实体集（entity set）：同一类型实体（即实体型）的集合。
6. 联系（relationship）：实体（型）内部的联系和实体（型）之间的联系。
   
   实体**内部**的联系通常是指组成实体的不同**属性**之间的联系，实体**之间**的联系通常是指不同**实体集**之间的联系。
   
   1. 单个实体型内部的联系
      ![单个实体型内的一对多联系示例](http://wsxq12.55555.io/单个实体型内的一对多联系示例.png)
   1. 实体之间的联系
      实体之间的联系主要有**一对一**、**一对多**和**多对多**三种类型。
   
      1. 一对一联系（1:1）：如果对于实体集A中的每一个实体，实体集B中至多有一个（**也可以没有**）实体与之联系， 反之亦然， 则称实体集A与实体集B具有一对一联系，记为`1:1`。
         
         例如，学校里一个班级只有一个正班长，而一个班长只在一个班中任职，则班级与班长之间具有一对一联系。
      
      2. 一对多联系（1:n）：如果对于实体集A中的每一个实体，实体集B中有n个实体（n>=0）与之联系，反之，对于实体集B中的每一个实体，实体集A中至多只有一个实体与之联系，则称实体集A与实体集B有一对多联系，记为`1:n`。
         
         例如，一个班级中有若干名学生，而每个学生只在一个班级中学习，则班级与学生之间具有一对多联系。
   
      3. 多对多联系（m:n）：如果对于实体集A中的每一个实体，实体集B中有n个实体（n>=0）与之联系，反之，对于实体集B中的每一个实体，实体集A中也有m个实体（m>=0）与之联系，则称实体集A与实体集B具有多对多联系，记为`m:n`。
   
         例如，一门课程同时有若干个学生选修，而一个学生可以同时选修多门课程，则课程与学生之间具有多对多联系。
   
      可以用图形来表示两个实体型之间的这三类联系：
      ![两个实体型之间的三类联系](http://wsxq12.55555.io/three_relationship_of_two_entity.png)

      一般地，两个以上的实体型之间也存在着一对一、一对多和多对多联系。如下图所示：
      ![三个实体型之间的联系示例](http://wsxq12.55555.io/三个实体型之间的联系示例.png)
      一般地，把参与联联系的实体型的数目称为联系的**度**。N个实体型之间的联系**度为N**，也称为**N元联系**。

#### 3.1.2 E-R图
E-R图提供了表示**实体型**、**属性**、和**联系**的方法。
1. **实体型**用**矩形**表示，矩形框内写明实体名。
2. **属性**用**椭圆形**表示，并用无向边将其与相应的实体型连接起来。
3. **联系**用**菱形**表示，并用无向边将其与相应的实体型连接起来。
联系也可以有属性。如下图：
![联系的属性](http://wsxq12.55555.io/联系的属性.png)

#### 3.1.3 完整示例
下面用E-R图来表示某个工厂物资管理的概念模型：
![完整的E-R图](http://wsxq12.55555.io/完整的E-R图.png)

### 3.2 设计技巧
#### 3.2.1 实体与属性的划分原则
**现实世界的事物能作为属性对待的尽量作为属性对待**。但对属性有如下要求：
1. 不能再具有需要描述的性质
2. 不能与其他实体具有联系
   
## 4 逻辑结构设计
逻辑结构设计的任务就是把概念结构设计阶段设计好的基本E-R图**转换**为与选用数据库管理系统产品所支持的数据模型相符合的逻辑结构。目前的数据库应用系统都采用支持关系数据模型的关系数据库管理系统，所以这里只介绍E-R图向关系数据模型的转换原则与方法。
### 4.1 E-R图向关系模型的转换
E-R图的三要素是**实体型**、**实体的属性**、**实体型之间的联系**；关系模型的逻辑结构是一组**关系模式的集合**。
1. 实体型：一个实体型转换为一个关系模式。**关系的属性**就是实体的属性，**关系的码**就是实体的码。
2. 实体型之间的联系：
   1. 一个`1:1`联系可以转换为一个独立的关系模式，也可以与**任意一端**对应的关系模式合并。如果转换为一个独立的关系模式，则与该联系相连的各实体的码以及联系本身的属性均转换为关系的属性，每个实体的码均是该关系的候选码；如果与某一端实体对应的关系模式合并，则需要在那一端关系模式的属性中加入另一端实体对应的关系模式的码和联系本身的属性。
   1. 一个`1:n`联系可以转换为一个独立的关系模式，也可以与**n端**对应的关系模式合并。如果转换为一个独立的关系模式，则与该联系相连的各实体的码以及联系本身的属性均转换为关系的属性，而关系的码为n端实体的码；如果与`n`端实体对应的关系模式合并，则需要在`n`端关系模式的属性中加入`1`端实体对应的关系模式的码和联系本身的属性。
   1. 一个`m:n`联系转换为一个关系模式。与该联系相连的各实体的码以及联系本身的属性均转换为**关系的属性**，各实体的码组成**关系的码或关系码的一部分**。
   1. 三个或三个以上实体间的一个多元联系可以转换为一个关系模式。与该多元联系相连的各实体的码以及联系本身的属性均转换为**关系的属性**，各实体的码组成**关系的码或关系码的一部分**。
   1. 具有相同**码**的关系模式可合并。

## 5 物理结构设计
## 6 数据库实施
## 7 数据库运行与维护
## 8 简单实例-公交安全管理系统
### 8.1 题目要求
![http://wsxq12.55555.io/公交安全管理系统题目要求1.PNG](http://wsxq12.55555.io/公交安全管理系统题目要求1.PNG)
![http://wsxq12.55555.io/公交安全管理系统题目要求2.PNG](http://wsxq12.55555.io/公交安全管理系统题目要求2.PNG)
![http://wsxq12.55555.io/公交安全管理系统题目要求3.PNG](http://wsxq12.55555.io/公交安全管理系统题目要求3.PNG)
![http://wsxq12.55555.io/公交安全管理系统题目要求4.PNG](http://wsxq12.55555.io/公交安全管理系统题目要求4.PNG)

### 8.2 概念模型设计
![公交安全管理系统E-R图](http://wsxq12.55555.io/公交安全管理系统E-R图.png)

### 8.3 逻辑结构设计
![公交安全管理系统逻辑模型](http://wsxq12.55555.io/公交安全管理系统逻辑模型.jpeg)

### 8.4 物理结构设计
![公交安全管理系统物理模型](http://wsxq12.55555.io/公交安全管理系统物理模型.jpeg)

### 8.5 前台程序设计
ERWin: For `.sql` files, change the 'Encoding' to 'ANSI' not 'Unicode'.   'Unicode' is not supported.

#### 8.5.1 C 语言
1. 开发环境搭建：`yum install mariadb-devel.x86_64`
2. 

#### 8.5.2 Web 网页设计
[用PHP和HTML写一个简单的网站登录注册项目][php-web-example]

[php-web-example]:https://blog.csdn.net/L_BestCoder/article/details/51234512

### 8.6 遇到的问题
1. MySQL Trigger to prevent INSERT under certain conditions?

   ```
   DELIMITER //
   
   CREATE TRIGGER zhiwei_siji
   BEFORE INSERT ON SiJi FOR EACH ROW
   BEGIN
   	DECLARE zw enum('司机','队长');
   	SELECT zhiwei FROM RenYuan WHERE RenYuan.gonghao=NEW.gonghao into zw;
   	if zw!='司机' then
   	   SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '插入的人员不是司机!';
   	end if;
   END;//
   
   DELIMITER ;
   ```
   详情参考： [MySQL Trigger to prevent INSERT under certain conditions ][triggers-prevent-insert]
   
   [triggers-prevent-insert]:https://stackoverflow.com/questions/2981930/mysql-trigger-to-prevent-insert-under-certain-conditions

2. Prepare Load Data Infile?
   > Prepare does not support Load Data Infile: The list of statements that you can run with PREPARE are documented in this page: https://dev.mysql.com/doc/refman/5.7/en/sql-syntax-prepared-statements.html under the subheading "SQL Syntax Allowed in Prepared Statements". Note this list may be different in earlier versions of MySQL.

   即如下语句是错误的：

   ```
   DELIMITER //
   DROP PROCEDURE IF EXISTS import_csv //
   CREATE PROCEDURE import_csv(tab_name TEXT)
   BEGIN
       SET @t1=CONCAT("LOAD DATA LOCAL INFILE 'csv/", tab_name, ".csv' INTO TABLE ", tab_name, " FIELDS TERMINATED BY ',' ENCLOSED BY '\"' LINES TERMINATED BY '\r\n'");
       SELECT @t1;
       PREPARE stmt FROM @t1;
       EXECUTE stmt;
       DEALLOCATE PREPARE stmt;
   END
   //
   DELIMITER ;
   DROP TABLE IF EXISTS RenYuan;
   CALL import_csv('RenYuan');
   ```

   错误如下：
   ```
   MariaDB [bus]>CALL import_csv('RenYuan');
   +-------------------------------------------------------------------------------------------------------------------------------+
   | @t1                                                                                                                           |
   +-------------------------------------------------------------------------------------------------------------------------------+
   | LOAD DATA LOCAL INFILE 'csv/RenYuan.csv' INTO TABLE RenYuan FIELDS TERMINATED BY ',' ENCLOSED BY '"' LINES TERMINATED BY '
   ' |
   +-------------------------------------------------------------------------------------------------------------------------------+
   1 row in set (0.00 sec)
   
   ERROR 1295 (HY000): This command is not supported in the prepared statement protocol yet
   ```
   
   
## 参考资料
以下参考资料按使用程度排序：
1. 《数据库系统概论（第五版）》，王珊 萨师煊 编著，高等教育出版社
2. [与《数据库系统概论（第五版）》配套的数字课程资源](http://abook.hep.com.cn/187532)
* [MySQL Trigger to prevent INSERT under certain conditions ][triggers-prevent-insert]
