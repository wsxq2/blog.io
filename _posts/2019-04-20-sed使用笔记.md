---
tags: [sed]
last_modified_time: 2019-04-20 23:12:59 +0800
---

本文主要提取自`man sed`和[Sed 使用参考手册](http://opus.konghy.cn/sed-refer/)。对于更详细的信息，可参阅 `info sed`

Sed 是一款流编辑工具，用来对文本进行过滤与替换操作。Sed 一次仅读取一行内容来对某些指令进行处理后输出，所以 Sed 处理大数据文件是很方便快捷的。

Sed 的工作流程是：首先，通过文件或者管道读取文件内容。Sed 默认并不直接修改源文件，而是将读入的内容赋值到缓冲区中，这被称之为模式空间，所有指令操作都是在模式空间中进行。然后， Sed 根据相应的指令对模式空间中的内容进行处理并输出，默认输出至标准输出（即屏幕）。

<p id="markdown-toc"></p>
<!-- vim-markdown-toc GFM -->

* [sed 命令行参数](#sed-命令行参数)
* [sed 常用格式](#sed-常用格式)
* [Zero-address commands](#zero-address-commands)
* [Zero- or One- address commands](#zero--or-one--address-commands)
* [Commands which accept address ranges](#commands-which-accept-address-ranges)
* [`s`命令 flag](#s命令-flag)
* [常见问题](#常见问题)
  * [取反](#取反)
* [实践记录](#实践记录)
  * [整理`nmap -sP`的输出结果](#整理nmap--sp的输出结果)
  * [整理`nmap -sS -p22 -oG`的输出结果](#整理nmap--ss--p22--og的输出结果)
  * [](#)
* [链接](#链接)

<!-- vim-markdown-toc -->

## sed 命令行参数
使用`sed --help`可得到如下帮助：
<pre>
Usage: sed [OPTION]... {script-only-if-no-other-script} [input-file]...

  -n, --quiet, --silent
                 suppress automatic printing of pattern space
  -e script, --expression=script
                 add the script to the commands to be executed
  -f script-file, --file=script-file
                 add the contents of script-file to the commands to be executed
  --follow-symlinks
                 follow symlinks when processing in place
  -i[SUFFIX], --in-place[=SUFFIX]
                 edit files in place (makes backup if SUFFIX supplied)
  -c, --copy
                 use copy instead of rename when shuffling files in -i mode
  -b, --binary
                 does nothing; for compatibility with WIN32/CYGWIN/MSDOS/EMX (
                 open files in binary mode (CR+LFs are not treated specially))
  -l N, --line-length=N
                 specify the desired line-wrap length for the `l' command
  --posix
                 disable all GNU extensions.
  -r, --regexp-extended
                 use extended regular expressions in the script.
  -s, --separate
                 consider files as separate rather than as a single continuous
                 long stream.
  -u, --unbuffered
                 load minimal amounts of data from the input files and flush
                 the output buffers more often
  -z, --null-data
                 separate lines by NUL characters
  --help
                 display this help and exit
  --version
                 output version information and exit

If no -e, --expression, -f, or --file option is given, then the first
non-option argument is taken as the sed script to interpret.  All
remaining arguments are names of input files; if no input files are
specified, then the standard input is read.

GNU sed home page: <http://www.gnu.org/software/sed/>.
General help using GNU software: <http://www.gnu.org/gethelp/>.
E-mail bug reports to: <bug-sed@gnu.org>.
Be sure to include the word 'ed' somewhere in the 'ubject:' field.
</pre>

## sed 常用格式

```
sed [options] 'script' file1 file2 ...
sed [options] –f scriptfile file1 file2 ...
sed 'script' file | sed 'script' | sed 'script'
sed 'statement1; statement2; statement3' file1 file2 ...
sed -e 'statement1' -e 'statement2' -e 'statement3' file1 file2 ...
```
通常一个`statement`为：
```
address{
    command1
    command2
    command3
}
```
如果`command`只有一个，则`{}`可以省去


## Zero-address commands

| `: label`  | Label for b and t commands.                                                      |
| `#comment` | The comment extends until the next newline (or the end of a -e script fragment). |
| `}`        | The closing bracket of a { } block.                                              |

## Zero- or One- address commands

| `=`             | Print the current line number.                                                                                                                                                                           |
| `a text`        | Append text, which has each embedded newline preceded by a backslash.                                                                                                                                    |
| `i text`        | Insert text, which has each embedded newline preceded by a backslash.                                                                                                                                    |
| `q [exit-code]` | Immediately quit the sed script without processing any more input, except that if auto-print is not disabled the current pattern space will  be  printed.	  The  exit  code argument is a GNU extension. |
| `Q [exit-code]` | Immediately quit the sed script without processing any more input.  This is a GNU extension.                                                                                                             |
| `r filename`    | Append text read from filename.                                                                                                                                                                          |
| `R filename`    | Append a line read from filename.	 Each invocation of the command reads a line from the file.  This is a GNU extension.                                                                                  |

## Commands which accept address ranges

| `{`                     | Begin a block of commands (end with a }).                                                                                                                                                                                                                                                                                                                                                   |
| `b label`               | Branch to label; if label is omitted, branch to end of script.                                                                                                                                                                                                                                                                                                                              |
| `c text`                | Replace the selected lines with text, which has each embedded newline preceded by a backslash.                                                                                                                                                                                                                                                                                              |
| `d`                     | Delete pattern space.  Start next cycle.                                                                                                                                                                                                                                                                                                                                                    |
| `D`                     | If  pattern  space  contains no newline, start a normal new cycle as if the d command was issued.	 Otherwise, delete text in the pattern space up to the first newline, and restart cycle with the resultant pattern space, without reading a new line of input.                                                                                                                            |
| `h H`                   | Copy/append pattern space to hold space.                                                                                                                                                                                                                                                                                                                                                    |
| `g G`                   | Copy/append hold space to pattern space.                                                                                                                                                                                                                                                                                                                                                    |
| `l`                     | List out the current line in a 'visually unambiguous' form.                                                                                                                                                                                                                                                                                                                                 |
| `l width`               | List out the current line in a 'visually unambiguous' form, breaking it at width characters.  This is a GNU extension.                                                                                                                                                                                                                                                                      |
| `n N`                   | Read/append the next line of input into the pattern space.                                                                                                                                                                                                                                                                                                                                  |
| `p`                     | Print the current pattern space.                                                                                                                                                                                                                                                                                                                                                            |
| `P`                     | Print up to the first embedded newline of the current pattern space.                                                                                                                                                                                                                                                                                                                        |
| `s/regexp/replacement/` | Attempt to match regexp against the pattern space.  If successful, replace that portion matched with replacement.	 The replacement may contain the special character  &  to refer to that portion of the pattern space which matched, and the special escapes \1 through \9 to refer to the corresponding matching sub-expressions in the regexp.                                           |
| `t label`               | If a s/// has done a successful substitution since the last input line was read and since the last t or T command, then branch to label; if label is omitted, branch to end of script.                                                                                                                                                                                                      |
| `T label`               | If no s/// has done a successful substitution since the last input line was read and since the last t or T command, then branch to label; if label is  omitted,  branch  to                                                                                                                                                                        end of script.  This is a GNU extension. |
| `w filename`            | Write the current pattern space to filename.                                                                                                                                                                                                                                                                                                                                                |
| `W filename`            | Write the first line of the current pattern space to filename.  This is a GNU extension.                                                                                                                                                                                                                                                                                                    |
| `x`                     | Exchange the contents of the hold and pattern spaces.                                                                                                                                                                                                                                                                                                                                       |
| `y/source/dest/`        | Transliterate the characters in the pattern space which appear in source to the corresponding character in dest.                                                                                                                                                                                                                                                                            |

## `s`命令 flag

| `n`      | 1 - 512 之间的数字，表示对模式空间中指定模式的第 n 次出现进行替换。如一行中有3个A，而只想替换第二个A。 |
| `g`      | 对模式空间的所有匹配进行全局更改。没有 g 则只有第一次匹配被替换。如一行中有3个A，则仅替换第一个A。     |
| `p`      | 打印模式空间的内容，即表示打印行。与-n选项一起使用可以只打印匹配的行。                                 |
| `w file` | 将模式空间的内容写到文件 file 中。 即表示把行写入一个文件。                                            |

## 常见问题
### 取反
```
find . -type f -name "*" | sed -n '/.abc/!p'
```

## 实践记录
### 整理`nmap -sP`的输出结果
执行`nmap -sP 192.168.56.0/24`得到的输出：
<pre>
Starting Nmap 6.40 ( http://nmap.org ) at 2019-04-20 18:06 CST
Nmap scan report for host (192.168.56.100)
Host is up (0.00014s latency).
MAC Address: 0A:00:27:00:00:1C (Unknown)
Nmap scan report for master (192.168.56.11)
Host is up.
Nmap done: 256 IP addresses (2 hosts up) scanned in 3.27 seconds
</pre>

从该输出中提取 IP 地址：
```
sed -n 's/.*[^0-9]\(\([[:digit:]]\{1,\}\.\)\{3\}[[:digit:]]\{1,\}\).*/\1/p' nmap-sP-results.txt
```

### 整理`nmap -sS -p22 -oG`的输出结果
执行`nmap -sS -p22 -oG a 202.117.0.0/16`命令得到的输出：
```
# Nmap 7.70 scan initiated Tue Dec  4 13:42:48 2018 as: nmap -sS -p22 -oG a 202.117.0.0/16
Host: 202.117.0.0 ()    Status: Up
Host: 202.117.0.0 ()    Ports: 22/filtered/tcp//ssh///
Host: 202.117.0.1 (0h1.xjtu.edu.cn) Status: Up
Host: 202.117.0.1 (0h1.xjtu.edu.cn) Ports: 22/filtered/tcp//ssh///
Host: 202.117.0.2 (0h2.xjtu.edu.cn) Status: Up
Host: 202.117.0.2 (0h2.xjtu.edu.cn) Ports: 22/filtered/tcp//ssh///
Host: 202.117.0.3 (0h3.xjtu.edu.cn) Status: Up
Host: 202.117.0.3 (0h3.xjtu.edu.cn) Ports: 22/filtered/tcp//ssh///
Host: 202.117.0.4 (0h4.xjtu.edu.cn) Status: Up
Host: 202.117.0.4 (0h4.xjtu.edu.cn) Ports: 22/filtered/tcp//ssh///
Host: 202.117.0.5 (voice-gw.xjtu.edu.cn)    Status: Up
Host: 202.117.0.5 (voice-gw.xjtu.edu.cn)    Ports: 22/filtered/tcp//ssh///
Host: 202.117.0.6 (0h6.xjtu.edu.cn) Status: Up
Host: 202.117.0.6 (0h6.xjtu.edu.cn) Ports: 22/filtered/tcp//ssh///
......
```

从该输出中提取信息：
```
# get active ip
sed -ne '/.*/{s/^Host: \([0-9.]\+\) .*/\1/p}' a

# get ssh-active ip
sed -ne '/22\/open\/tcp/{s/^Host: \([0-9.]\+\) (.*/\1/p}' a

# get domain-name-haved ip and domain-name
sed -ne '/.*/{s/^Host: \([0-9.]\+ ([^)]\+)\).*/\1/p}' a

# get ssh-active and domain-name-haved ip and domain-name
sed -ne '/22\/open\/tcp/{s/^Host: \([0-9.]\+ ([^)]\+)\).*/\1/p}' a
```

### 

## 链接
下面总结了本文中使用的所有链接：

<!-- link start -->

* [Sed 使用参考手册](http://opus.konghy.cn/sed-refer/)
<!-- link end -->
